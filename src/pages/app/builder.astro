---
/**
 * AI System Builder
 * Supports Architect (Planning) and Engineer (Execution) modes.
 */
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
---

<Layout title="AI System Builder">
    <main id="app"></main>

    <!-- Load React and Markdown library -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        import React, { useState, useEffect, useRef } from "react";
        import { createRoot } from "react-dom/client";

        // Expose React
        (window as any).React = React;
        const h = React.createElement;

        // Role Types
        type AgentRole = "architect" | "engineer";

        function SystemBuilder() {
            const [role, setRole] = useState<AgentRole>("architect");
            const [prompt, setPrompt] = useState("");
            const [history, setHistory] = useState<
                Array<{ role: string; content: string; type?: "text" | "logs" }>
            >([
                {
                    role: "assistant",
                    content:
                        "Hello! I am your AI Architect. Describe the system you want to build.",
                    type: "text",
                },
            ]);
            const [isLoading, setIsLoading] = useState(false);

            // Default project ID from URL or random
            const [projectId, setProjectId] = useState(() => {
                const params = new URLSearchParams(window.location.search);
                return (
                    params.get("projectId") ||
                    "new-project-" + Math.random().toString(36).substring(7)
                );
            });

            // Auto-scroll to bottom
            const messagesEndRef = useRef<HTMLDivElement>(null);
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [history]);

            const handleSend = async () => {
                if (!prompt.trim() || isLoading) return;

                const userMsg = prompt;
                setPrompt("");
                setHistory((prev) => [
                    ...prev,
                    { role: "user", content: userMsg, type: "text" },
                ]);
                setIsLoading(true);

                try {
                    const endpoint =
                        role === "architect"
                            ? "/api/agent/architect"
                            : "/api/agent/engineer";
                    const body =
                        role === "architect"
                            ? { projectId, prompt: userMsg }
                            : { projectId, instructions: userMsg };

                    const res = await fetch(endpoint, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body),
                    });

                    const data = await res.json();

                    if (data.error) {
                        setHistory((prev) => [
                            ...prev,
                            {
                                role: "system",
                                content: `Error: ${data.error}`,
                                type: "text",
                            },
                        ]);
                    } else if (role === "architect") {
                        // Architect returns content
                        setHistory((prev) => [
                            ...prev,
                            {
                                role: "assistant",
                                content: data.content || "Design complete.",
                                type: "text",
                            },
                        ]);
                    } else {
                        // Engineer returns logs
                        const logs = (data.logs || []).join("\n");
                        setHistory((prev) => [
                            ...prev,
                            { role: "assistant", content: logs, type: "logs" },
                        ]);
                    }
                } catch (e: any) {
                    setHistory((prev) => [
                        ...prev,
                        {
                            role: "system",
                            content: `Network Error: ${e.message}`,
                            type: "text",
                        },
                    ]);
                } finally {
                    setIsLoading(false);
                }
            };

            const renderMessage = (
                msg: { role: string; content: string; type?: "text" | "logs" },
                index: number,
            ) => {
                const isUser = msg.role === "user";
                const isLogs = msg.type === "logs";

                // Use marked for markdown
                const htmlContent = isLogs
                    ? ""
                    : (window as any).marked.parse(msg.content);

                return h(
                    "div",
                    {
                        key: index,
                        style: {
                            alignSelf: isUser ? "flex-end" : "flex-start",
                            maxWidth: "85%",
                            background: isUser
                                ? "#4f46e5"
                                : isLogs
                                  ? "#1f2937"
                                  : "white",
                            color: isUser
                                ? "white"
                                : isLogs
                                  ? "#10b981"
                                  : "#1f2937",
                            padding: "1rem",
                            borderRadius: "12px",
                            boxShadow: "0 1px 3px rgba(0,0,0,0.1)",
                            marginBottom: "1rem",
                            fontFamily: isLogs
                                ? "monospace"
                                : "system-ui, sans-serif",
                            whiteSpace: isLogs ? "pre-wrap" : "normal",
                            fontSize: isLogs ? "0.8rem" : "1rem",
                        },
                    },
                    isLogs
                        ? msg.content
                        : h("div", {
                              dangerouslySetInnerHTML: { __html: htmlContent },
                          }),
                );
            };

            return h(
                "div",
                {
                    style: {
                        display: "flex",
                        flexDirection: "column",
                        height: "100vh",
                        background: "#f3f4f6",
                    },
                },
                // Header
                h(
                    "header",
                    {
                        style: {
                            background: "white",
                            padding: "1rem",
                            borderBottom: "1px solid #e5e7eb",
                            display: "flex",
                            justifyContent: "space-between",
                            alignItems: "center",
                        },
                    },
                    h(
                        "div",
                        null,
                        h(
                            "h1",
                            { style: { margin: 0, fontSize: "1.25rem" } },
                            "AI System Builder",
                        ),
                        h(
                            "div",
                            { style: { fontSize: "0.8rem", color: "#6b7280" } },
                            `Project ID: ${projectId}`,
                        ),
                    ),
                    h(
                        "div",
                        {
                            style: {
                                display: "flex",
                                gap: "0.5rem",
                                background: "#e5e7eb",
                                padding: "0.25rem",
                                borderRadius: "8px",
                            },
                        },
                        h(
                            "button",
                            {
                                onClick: () => setRole("architect"),
                                style: {
                                    padding: "0.5rem 1rem",
                                    background:
                                        role === "architect"
                                            ? "white"
                                            : "transparent",
                                    border: "none",
                                    borderRadius: "6px",
                                    boxShadow:
                                        role === "architect"
                                            ? "0 1px 2px rgba(0,0,0,0.05)"
                                            : "none",
                                    cursor: "pointer",
                                    fontWeight: "500",
                                },
                            },
                            "ðŸ›ï¸ Architect",
                        ),
                        h(
                            "button",
                            {
                                onClick: () => setRole("engineer"),
                                style: {
                                    padding: "0.5rem 1rem",
                                    background:
                                        role === "engineer"
                                            ? "white"
                                            : "transparent",
                                    border: "none",
                                    borderRadius: "6px",
                                    boxShadow:
                                        role === "engineer"
                                            ? "0 1px 2px rgba(0,0,0,0.05)"
                                            : "none",
                                    cursor: "pointer",
                                    fontWeight: "500",
                                },
                            },
                            "ðŸ”§ Engineer",
                        ),
                    ),
                ),

                // Chat Area
                h(
                    "div",
                    {
                        style: {
                            flex: 1,
                            overflow: "auto",
                            padding: "2rem",
                            display: "flex",
                            flexDirection: "column",
                        },
                    },
                    history.map(renderMessage),
                    isLoading &&
                        h(
                            "div",
                            {
                                style: {
                                    alignSelf: "flex-start",
                                    padding: "1rem",
                                    background: "white",
                                    borderRadius: "12px",
                                },
                            },
                            "Thinking...",
                        ),
                    h("div", { ref: messagesEndRef }),
                ),

                // Input Area
                h(
                    "div",
                    {
                        style: {
                            background: "white",
                            padding: "1rem",
                            borderTop: "1px solid #e5e7eb",
                            display: "flex",
                            gap: "1rem",
                        },
                    },
                    h("textarea", {
                        value: prompt,
                        onChange: (e: any) => setPrompt(e.target.value),
                        onKeyDown: (e: any) => {
                            if (e.key === "Enter" && !e.shiftKey) {
                                e.preventDefault();
                                handleSend();
                            }
                        },
                        placeholder:
                            role === "architect"
                                ? "Describe your system requirements..."
                                : "Approve the plan and ask to build it...",
                        style: {
                            flex: 1,
                            padding: "1rem",
                            borderRadius: "8px",
                            border: "1px solid #d1d5db",
                            resize: "none",
                            height: "80px",
                            fontFamily: "inherit",
                        },
                    }),
                    h(
                        "button",
                        {
                            onClick: handleSend,
                            disabled: isLoading || !prompt.trim(),
                            style: {
                                padding: "0 2rem",
                                background: "#4f46e5",
                                color: "white",
                                border: "none",
                                borderRadius: "8px",
                                fontWeight: "600",
                                cursor: isLoading ? "not-allowed" : "pointer",
                                opacity: isLoading ? 0.7 : 1,
                            },
                        },
                        "Send",
                    ),
                ),
            );
        }

        const root = createRoot(document.getElementById("app")!);
        root.render(h(SystemBuilder, null));
    </script>
</Layout>

<style>
    body {
        margin: 0;
        font-family:
            system-ui,
            -apple-system,
            sans-serif;
    }
</style>
