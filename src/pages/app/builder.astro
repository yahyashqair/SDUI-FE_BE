---
/**
 * AI System Builder
 * Supports Architect (Planning) and Engineer (Execution) modes.
 */
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
---

<Layout title="AI System Builder">
    <main id="app"></main>

    <!-- Load React -->
    <script>
        import React, { useState, useEffect, useRef } from "react";
        import { createRoot } from "react-dom/client";
        import { marked } from "marked";

        // Expose React
        (window as any).React = React;
        const h = React.createElement;

        // Role Types
        type AgentRole = "architect" | "engineer";

        function SystemBuilder() {
            const [role, setRole] = useState<AgentRole>("architect");
            const [prompt, setPrompt] = useState("");
            const [history, setHistory] = useState<
                Array<{ role: string; content: string; type?: "text" | "logs" }>
            >([
                {
                    role: "assistant",
                    content:
                        "Hello! I am your AI Architect. Describe the system you want to build.",
                    type: "text",
                },
            ]);
            const [isLoading, setIsLoading] = useState(false);

            // Default project ID from URL or random
            const [projectId, setProjectId] = useState(() => {
                const params = new URLSearchParams(window.location.search);
                return (
                    params.get("projectId") ||
                    "new-project-" + Math.random().toString(36).substring(7)
                );
            });

            // Auto-scroll to bottom
            const messagesEndRef = useRef<HTMLDivElement>(null);
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [history]);

            const handleSend = async () => {
                if (!prompt.trim() || isLoading) return;

                const userMsg = prompt;
                setPrompt("");
                setHistory((prev) => [
                    ...prev,
                    { role: "user", content: userMsg, type: "text" },
                ]);
                setIsLoading(true);

                // Add placeholder for assistant response
                setHistory((prev) => [
                    ...prev,
                    { role: "assistant", content: "", type: "text" },
                ]);

                try {
                    const endpoint =
                        role === "architect"
                            ? "/api/agent/architect"
                            : "/api/agent/engineer";

                    const conversationHistory = history
                        .map((h) => ({
                            role: h.role === "assistant" ? "assistant" : "user",
                            content: h.content,
                        }))
                        .filter(
                            (h) => h.role === "user" || h.role === "assistant",
                        );

                    const messages = [
                        ...conversationHistory,
                        { role: "user", content: userMsg },
                    ];

                    const body = { projectId, messages };

                    const res = await fetch(endpoint, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body),
                    });

                    if (!res.ok) throw new Error(res.statusText);
                    if (!res.body) throw new Error("No response body");

                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = "";

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split("\n\n");
                        buffer = lines.pop() || "";

                        for (const line of lines) {
                            if (!line.startsWith("data: ")) continue;
                            const data = line.slice(6);
                            if (!data) continue;

                            try {
                                const event = JSON.parse(data);

                                if (event.type === "token") {
                                    setHistory((prev) => {
                                        const newHistory = [...prev];
                                        const lastMsg =
                                            newHistory[newHistory.length - 1];
                                        if (
                                            lastMsg.role === "assistant" &&
                                            lastMsg.type === "text"
                                        ) {
                                            lastMsg.content += event.content;
                                        }
                                        return newHistory;
                                    });
                                } else if (
                                    event.type === "log" ||
                                    event.type === "tool_start" ||
                                    event.type === "tool_end"
                                ) {
                                    // Append logs
                                    setHistory((prev) => {
                                        const newHistory = [...prev];
                                        const lastMsg =
                                            newHistory[newHistory.length - 1];

                                        // If last message is logs, append to it, otherwise create new logs message
                                        if (lastMsg.type === "logs") {
                                            let logText = "";
                                            if (event.type === "log")
                                                logText = event.content;
                                            if (event.type === "tool_start")
                                                logText = `> Executing ${event.tool}...`;
                                            if (event.type === "tool_end")
                                                logText = `> Tool ${event.tool} finished.`;

                                            lastMsg.content +=
                                                (lastMsg.content ? "\n" : "") +
                                                logText;
                                            return newHistory;
                                        } else {
                                            let logText = "";
                                            if (event.type === "log")
                                                logText = event.content;
                                            if (event.type === "tool_start")
                                                logText = `> Executing ${event.tool}...`;
                                            if (event.type === "tool_end")
                                                logText = `> Tool ${event.tool} finished.`;

                                            return [
                                                ...newHistory,
                                                {
                                                    role: "assistant",
                                                    content: logText,
                                                    type: "logs",
                                                },
                                                {
                                                    role: "assistant",
                                                    content: "",
                                                    type: "text",
                                                }, // Prepare for next text token
                                            ];
                                        }
                                    });
                                } else if (event.type === "error") {
                                    setHistory((prev) => [
                                        ...prev,
                                        {
                                            role: "system",
                                            content: `Error: ${event.error}`,
                                            type: "text",
                                        },
                                    ]);
                                }
                            } catch (e) {
                                console.error("Error parsing SSE event", e);
                            }
                        }
                    }
                } catch (e: any) {
                    setHistory((prev) => [
                        ...prev,
                        {
                            role: "system",
                            content: `Network Error: ${e.message}`,
                            type: "text",
                        },
                    ]);
                } finally {
                    setIsLoading(false);
                }
            };

            const renderMessage = (
                msg: { role: string; content: string; type?: "text" | "logs" },
                index: number,
            ) => {
                const isUser = msg.role === "user";
                const isLogs = msg.type === "logs";

                const htmlContent = isLogs ? "" : marked.parse(msg.content);

                return h(
                    "div",
                    {
                        key: index,
                        style: {
                            alignSelf: isUser ? "flex-end" : "flex-start",
                            maxWidth: "85%",
                            background: isUser
                                ? "#4f46e5"
                                : isLogs
                                  ? "#1f2937"
                                  : "white",
                            color: isUser
                                ? "white"
                                : isLogs
                                  ? "#10b981"
                                  : "#1f2937",
                            padding: "1rem",
                            borderRadius: "12px",
                            boxShadow: "0 1px 3px rgba(0,0,0,0.1)",
                            marginBottom: "1rem",
                            fontFamily: isLogs
                                ? "monospace"
                                : "system-ui, sans-serif",
                            whiteSpace: isLogs ? "pre-wrap" : "normal",
                            fontSize: isLogs ? "0.8rem" : "1rem",
                        },
                    },
                    isLogs
                        ? msg.content
                        : h("div", {
                              dangerouslySetInnerHTML: { __html: htmlContent },
                          }),
                );
            };

            return h(
                "div",
                {
                    style: {
                        display: "flex",
                        flexDirection: "column",
                        height: "100vh",
                        background: "#f3f4f6",
                    },
                },
                // Header
                h(
                    "header",
                    {
                        style: {
                            background: "white",
                            padding: "1rem",
                            borderBottom: "1px solid #e5e7eb",
                            display: "flex",
                            justifyContent: "space-between",
                            alignItems: "center",
                        },
                    },
                    h(
                        "div",
                        null,
                        h(
                            "h1",
                            { style: { margin: 0, fontSize: "1.25rem" } },
                            "AI System Builder",
                        ),
                        h(
                            "div",
                            { style: { fontSize: "0.8rem", color: "#6b7280" } },
                            `Project ID: ${projectId}`,
                        ),
                    ),
                    h(
                        "div",
                        {
                            style: {
                                display: "flex",
                                gap: "0.5rem",
                                background: "#e5e7eb",
                                padding: "0.25rem",
                                borderRadius: "8px",
                            },
                        },
                        h(
                            "button",
                            {
                                onClick: () => setRole("architect"),
                                style: {
                                    padding: "0.5rem 1rem",
                                    background:
                                        role === "architect"
                                            ? "white"
                                            : "transparent",
                                    border: "none",
                                    borderRadius: "6px",
                                    boxShadow:
                                        role === "architect"
                                            ? "0 1px 2px rgba(0,0,0,0.05)"
                                            : "none",
                                    cursor: "pointer",
                                    fontWeight: "500",
                                },
                            },
                            "ðŸ›ï¸ Architect",
                        ),
                        h(
                            "button",
                            {
                                onClick: () => setRole("engineer"),
                                style: {
                                    padding: "0.5rem 1rem",
                                    background:
                                        role === "engineer"
                                            ? "white"
                                            : "transparent",
                                    border: "none",
                                    borderRadius: "6px",
                                    boxShadow:
                                        role === "engineer"
                                            ? "0 1px 2px rgba(0,0,0,0.05)"
                                            : "none",
                                    cursor: "pointer",
                                    fontWeight: "500",
                                },
                            },
                            "ðŸ”§ Engineer",
                        ),
                    ),
                ),

                // Chat Area
                h(
                    "div",
                    {
                        style: {
                            flex: 1,
                            overflow: "auto",
                            padding: "2rem",
                            display: "flex",
                            flexDirection: "column",
                        },
                    },
                    history.map(renderMessage),
                    isLoading &&
                        h(
                            "div",
                            {
                                style: {
                                    alignSelf: "flex-start",
                                    padding: "1rem",
                                    background: "white",
                                    borderRadius: "12px",
                                },
                            },
                            "Thinking...",
                        ),
                    h("div", { ref: messagesEndRef }),
                ),

                // Input Area
                h(
                    "div",
                    {
                        style: {
                            background: "white",
                            padding: "1rem",
                            borderTop: "1px solid #e5e7eb",
                            display: "flex",
                            gap: "1rem",
                        },
                    },
                    h("textarea", {
                        value: prompt,
                        onChange: (e: any) => setPrompt(e.target.value),
                        onKeyDown: (e: any) => {
                            if (e.key === "Enter" && !e.shiftKey) {
                                e.preventDefault();
                                handleSend();
                            }
                        },
                        placeholder:
                            role === "architect"
                                ? "Describe your system requirements..."
                                : "Approve the plan and ask to build it...",
                        style: {
                            flex: 1,
                            padding: "1rem",
                            borderRadius: "8px",
                            border: "1px solid #d1d5db",
                            resize: "none",
                            height: "80px",
                            fontFamily: "inherit",
                        },
                    }),
                    h(
                        "button",
                        {
                            onClick: handleSend,
                            disabled: isLoading || !prompt.trim(),
                            style: {
                                padding: "0 2rem",
                                background: "#4f46e5",
                                color: "white",
                                border: "none",
                                borderRadius: "8px",
                                fontWeight: "600",
                                cursor: isLoading ? "not-allowed" : "pointer",
                                opacity: isLoading ? 0.7 : 1,
                            },
                        },
                        "Send",
                    ),
                ),
            );
        }

        const root = createRoot(document.getElementById("app")!);
        root.render(h(SystemBuilder, null));
    </script>
</Layout>

<style>
    body {
        margin: 0;
        font-family:
            system-ui,
            -apple-system,
            sans-serif;
    }
</style>
