---
import Layout from '../../../layouts/Layout.astro';
import { PlatformDB } from '../../../db/platform';
import { FileSystem } from '../../../db/fs';
import { generateApp } from '../../../lib/ai/agent';
import { initTenantDB } from '../../../db/tenant';

const { projectId } = Astro.params;
const project = PlatformDB.getProject(projectId as string);
const blueprint = PlatformDB.getActiveBlueprint(projectId as string);

if (!project) return Astro.redirect('/builder');

// Init FileSystem if needed
await FileSystem.initProject(project.id);

let currentFile = null;
let currentFileContent = '';

// Handle Actions
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action');

  if (action === 'generate') {
    const prompt = formData.get('prompt') as string;
    const generated = await generateApp(prompt);

    // Save generated artifacts
    PlatformDB.saveBlueprint(project.id, generated.uiSchema, generated.dataSchema);
    initTenantDB(project.id, generated.dataSchema);

    // Save functions to FileSystem
    for (const fn of generated.functions) {
      const fileName = `${fn.name}.js`;
      await FileSystem.writeFile(project.id, fileName, fn.code);
      // Register mapping
      PlatformDB.saveFunction(project.id, fn.name, fileName);
    }

    await FileSystem.commit(project.id, `AI Generated: ${prompt}`);

  } else if (action === 'save_ui') {
      const uiJson = formData.get('ui_schema') as string;
      const currentBp = PlatformDB.getActiveBlueprint(project.id);
      const dataSchema = currentBp ? JSON.parse(currentBp.data_schema) : { tables: [] };
      try {
          const parsedUI = JSON.parse(uiJson);
          PlatformDB.saveBlueprint(project.id, parsedUI, dataSchema);
      } catch(e) {}

  } else if (action === 'save_file') {
      const fileName = formData.get('filename') as string;
      const content = formData.get('content') as string;
      await FileSystem.writeFile(project.id, fileName, content);

      // If it's a top level JS file, maybe register it as a function automatically?
      // For now, let's assume manual registration or existing registration.
      // Or we can register it if it matches a convention.
      if (fileName.endsWith('.js')) {
          const name = fileName.replace('.js', '');
          PlatformDB.saveFunction(project.id, name, fileName);
      }

  } else if (action === 'create_file') {
      const fileName = formData.get('new_filename') as string;
      await FileSystem.writeFile(project.id, fileName, '// New file');

  } else if (action === 'commit') {
      const msg = formData.get('message') as string;
      await FileSystem.commit(project.id, msg);
  } else if (action === 'open_file') {
      currentFile = formData.get('filename') as string;
      try {
        currentFileContent = FileSystem.readFile(project.id, currentFile);
      } catch (e) {
        currentFile = null;
      }
  }

  // Reload current file content if we just saved it
  if (action === 'save_file' && formData.get('filename')) {
      currentFile = formData.get('filename') as string;
      currentFileContent = FileSystem.readFile(project.id, currentFile);
  }
}

const files = FileSystem.listFiles(project.id);
const uiSchemaStr = blueprint ? JSON.stringify(JSON.parse(blueprint.ui_schema), null, 2) : '{}';
---

<Layout title={`Builder - ${project.name}`}>
  <div class="flex h-screen bg-gray-100">
    <!-- Sidebar -->
    <div class="w-64 bg-gray-900 text-white flex flex-col">
      <div class="p-4 border-b border-gray-700">
        <h1 class="font-bold text-xl">{project.name}</h1>
        <a href="/builder" class="text-xs text-gray-400 hover:text-white">‚Üê Back to Dashboard</a>
      </div>

      <div class="p-4 flex-1 overflow-y-auto">
        <div class="flex justify-between items-center mb-2">
            <h2 class="text-xs font-semibold uppercase text-gray-500">Files</h2>
            <form method="POST" class="inline">
                <input type="hidden" name="action" value="create_file" />
                <input type="text" name="new_filename" placeholder="+ New File" class="w-20 text-xs bg-gray-800 border-none rounded px-1 text-white placeholder-gray-500 focus:w-32 transition-all" />
            </form>
        </div>
        <ul class="space-y-1">
          {files.map(f => (
            <li class="text-sm">
                <form method="POST">
                    <input type="hidden" name="action" value="open_file" />
                    <input type="hidden" name="filename" value={f.path} />
                    <button class={`w-full text-left p-2 rounded hover:bg-gray-800 ${currentFile === f.path ? 'bg-gray-700' : ''}`}>
                        {f.type === 'directory' ? 'üìÅ' : 'üìÑ'} {f.name}
                    </button>
                </form>
            </li>
          ))}
        </ul>
      </div>

      <div class="p-4 border-t border-gray-700">
          <form method="POST" class="mb-2">
              <input type="hidden" name="action" value="commit" />
              <div class="flex gap-1">
                  <input type="text" name="message" placeholder="Commit msg" class="flex-1 bg-gray-800 border-none rounded text-xs px-2 py-1 text-white" required />
                  <button class="bg-blue-600 text-xs px-2 py-1 rounded">Commit</button>
              </div>
          </form>
          <a href={`/app/${project.id}/`} target="_blank" class="block w-full text-center bg-green-600 hover:bg-green-700 p-2 rounded text-sm font-bold">
            Open App ‚Üó
          </a>
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- AI Bar -->
      <div class="bg-white p-4 border-b shadow-sm">
        <form method="POST" class="flex gap-2">
          <input type="hidden" name="action" value="generate" />
          <input
            type="text"
            name="prompt"
            placeholder="Describe the app you want to build (e.g. 'A todo app with database')"
            class="flex-1 p-2 border rounded shadow-inner"
          />
          <button class="bg-purple-600 text-white px-6 py-2 rounded font-medium hover:bg-purple-700 flex items-center gap-2">
            <span>‚ú® Generate with AI</span>
          </button>
        </form>
      </div>

      <!-- Editors -->
      <div class="flex-1 flex overflow-hidden">
        <!-- UI Editor -->
        <div class={`flex-1 p-4 flex flex-col border-r ${currentFile ? 'hidden md:flex' : 'flex'}`}>
          <h2 class="font-bold mb-2 flex justify-between">
              UI Schema (JSON)
          </h2>
          <form method="POST" class="flex-1 flex flex-col">
              <input type="hidden" name="action" value="save_ui" />
              <textarea
                name="ui_schema"
                class="flex-1 font-mono text-sm p-4 bg-gray-50 border rounded resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
              >{uiSchemaStr}</textarea>
              <button class="mt-2 bg-blue-600 text-white px-4 py-2 rounded self-end">Save UI</button>
          </form>
        </div>

        <!-- Code Editor -->
        {currentFile && (
        <div class="flex-1 p-4 flex flex-col bg-gray-50">
           <h2 class="font-bold mb-2 flex justify-between">
               {currentFile}
               <button onclick="document.getElementById('codeForm').submit()" class="text-xs bg-blue-600 text-white px-3 py-1 rounded">Save File</button>
           </h2>

           <form id="codeForm" method="POST" class="flex-1 flex flex-col">
               <input type="hidden" name="action" value="save_file" />
               <input type="hidden" name="filename" value={currentFile} />
               <textarea
                 name="content"
                 class="flex-1 font-mono text-sm p-4 bg-white border rounded resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
               >{currentFileContent}</textarea>
           </form>
        </div>
        )}

        {!currentFile && (
            <div class="flex-1 p-12 flex flex-col items-center justify-center text-gray-400 bg-gray-50">
                <div class="text-4xl mb-4">‚Üê</div>
                <p>Select a file to edit code</p>
            </div>
        )}
      </div>
    </div>
  </div>
</Layout>
